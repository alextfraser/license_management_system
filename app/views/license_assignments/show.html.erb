<div class="max-w-7xl">
  <div class="mb-6">
    <%= link_to "← Back to #{@account.name}", account_path(@account), class: "text-gray-600 hover:text-gray-900" %>
  </div>

  <div class="bg-white shadow rounded-lg p-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Account: <%= @account.name %></h1>

    <%= form_with url: bulk_assign_account_license_assignment_path(@account), method: :post, id: "assign-form" do %>
      <div class="grid grid-cols-3 gap-6">
        <!-- Left: Product Licenses -->
        <div>
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-xl font-bold text-gray-900">Product Licenses</h2>
              <p class="text-sm text-gray-500">Showing active subscriptions only</p>
            </div>
            <% if @subscriptions.any? %>
              <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer">
                <input type="checkbox" 
                       id="select-all-products" 
                       class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                <span class="font-medium">Select All</span>
              </label>
            <% end %>
          </div>
          <div class="border border-gray-300 rounded-lg p-4 space-y-3 bg-gray-50" style="min-height: 400px;">
            <% if @subscriptions.any? %>
              <% @subscriptions.each do |subscription| %>
                <label class="flex items-center space-x-3 cursor-pointer hover:bg-white p-2 rounded transition">
                  <input type="checkbox" 
                         name="product_ids[]" 
                         value="<%= subscription.product.id %>" 
                         class="product-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                  <div class="flex-1">
                    <span class="text-gray-900 font-medium"><%= subscription.product.name %></span>
                    <span class="text-gray-600">(<%= subscription.used_licenses %>/<%= subscription.number_of_licenses %>)</span>
                  </div>
                </label>
              <% end %>
            <% else %>
              <p class="text-gray-500 text-center py-8">No active subscriptions</p>
            <% end %>
          </div>
        </div>

        <!-- Center: Buttons -->
        <div class="flex flex-col items-center justify-center space-y-4">
          <button type="submit" 
                  id="assign-btn"
                  disabled
                  class="w-full px-6 py-3 rounded-lg font-medium text-lg transition disabled:opacity-50 disabled:cursor-not-allowed bg-blue-600 hover:bg-blue-700 disabled:hover:bg-blue-600 text-white">
            Assign
          </button>
          
          <button type="button" 
                  id="unassign-btn"
                  disabled
                  class="w-full px-6 py-3 rounded-lg font-medium text-lg transition disabled:opacity-50 disabled:cursor-not-allowed bg-gray-500 hover:bg-gray-600 disabled:hover:bg-gray-500 text-white">
            Unassign
          </button>
        </div>

        <!-- Right: Users -->
        <div>
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-gray-900">Users</h2>
            <% if @users.any? %>
              <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer">
                <input type="checkbox" 
                       id="select-all-users" 
                       class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                <span class="font-medium">Select All</span>
              </label>
            <% end %>
          </div>
          <div class="border border-gray-300 rounded-lg p-4 space-y-3 bg-gray-50" style="min-height: 400px;">
            <% if @users.any? %>
              <% @users.each do |user| %>
                <label class="flex items-center space-x-3 cursor-pointer hover:bg-white p-2 rounded transition">
                  <input type="checkbox" 
                         name="user_ids[]" 
                         value="<%= user.id %>" 
                         class="user-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                  <span class="text-gray-900"><%= user.name %></span>
                </label>
              <% end %>
            <% else %>
              <p class="text-gray-500 text-center py-8">
                No users yet.
                <%= link_to "Add users", account_users_path(@account), class: "text-blue-600 hover:underline" %>
              </p>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Hidden form for unassign -->
    <%= form_with url: bulk_unassign_account_license_assignment_path(@account), method: :delete, id: "unassign-form", class: "hidden" do %>
      <!-- Product checkboxes will be cloned here via JS -->
    <% end %>

    <!-- Current Assignments Section -->
    <% if @license_assignments.any? %>
      <div class="mt-12">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Current License Assignments</h2>
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <% @license_assignments.group_by(&:product).each do |product, assignments| %>
              <div class="bg-white p-4 rounded border border-gray-200">
                <h3 class="font-semibold text-gray-900 mb-2"><%= product.name %></h3>
                <ul class="text-sm text-gray-700 space-y-1">
                  <% assignments.each do |assignment| %>
                    <li>• <%= assignment.user.name %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
  function initializeLicenseAssignments() {
    const assignForm = document.getElementById('assign-form');
    const unassignForm = document.getElementById('unassign-form');
    const assignBtn = document.getElementById('assign-btn');
    const unassignBtn = document.getElementById('unassign-btn');
    
    if (!assignBtn || !unassignBtn) return; // Exit if elements not found
    
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    const userCheckboxes = document.querySelectorAll('.user-checkbox');
    const selectAllProducts = document.getElementById('select-all-products');
    const selectAllUsers = document.getElementById('select-all-users');
    
    // Function to update button states
    function updateButtonStates() {
      const hasProductSelected = Array.from(productCheckboxes).some(cb => cb.checked);
      const hasUserSelected = Array.from(userCheckboxes).some(cb => cb.checked);
      const bothSelected = hasProductSelected && hasUserSelected;
      
      // Enable buttons only when both sides have selections
      assignBtn.disabled = !bothSelected;
      unassignBtn.disabled = !bothSelected;
    }
    
    // Select All Products
    if (selectAllProducts) {
      selectAllProducts.addEventListener('change', function() {
        productCheckboxes.forEach(cb => cb.checked = this.checked);
        updateButtonStates();
      });
    }
    
    // Select All Users
    if (selectAllUsers) {
      selectAllUsers.addEventListener('change', function() {
        userCheckboxes.forEach(cb => cb.checked = this.checked);
        updateButtonStates();
      });
    }
    
    // Update select all checkboxes when individual items are clicked
    productCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        if (selectAllProducts) {
          selectAllProducts.checked = Array.from(productCheckboxes).every(cb => cb.checked);
        }
        updateButtonStates();
      });
    });
    
    userCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        if (selectAllUsers) {
          selectAllUsers.checked = Array.from(userCheckboxes).every(cb => cb.checked);
        }
        updateButtonStates();
      });
    });
    
    // Unassign button handler - clone checked checkboxes to unassign form
    unassignBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Clear previous checkboxes
      unassignForm.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.remove());
      
      // Clone checked product checkboxes
      assignForm.querySelectorAll('input[name="product_ids[]"]:checked').forEach(checkbox => {
        const clone = checkbox.cloneNode(true);
        unassignForm.appendChild(clone);
      });
      
      // Clone checked user checkboxes
      assignForm.querySelectorAll('input[name="user_ids[]"]:checked').forEach(checkbox => {
        const clone = checkbox.cloneNode(true);
        unassignForm.appendChild(clone);
      });
      
      unassignForm.submit();
    });
    
    // Initialize button states on page load
    updateButtonStates();
  }
  
  // Initialize on both DOMContentLoaded (first load) and turbo:load (Turbo navigation)
  document.addEventListener('DOMContentLoaded', initializeLicenseAssignments);
  document.addEventListener('turbo:load', initializeLicenseAssignments);
</script>
